# CircleCI 2.0 configuration file for running Python on macOS.
#
# Email notifications are configured only from web.
# See "Email Preferences by Organization" in
# https://circleci.com/account/notifications
#
# Based on these v1.0 steps:
# https://pewpewthespells.com/blog/building_python_on_circleci.html
#
version: 2

jobs:
  build_static_checkers:
    working_directory: ~/static-checkers
    docker:
      # Alpine should be small and the generic python 2 should give us
      # latest Python version.
      - image: python/2-alpine3.7
    steps:
      # Get the source.
      - checkout

      # Run each checker in a separate step.
      - run:
          name: Check newsfragment.
          command: |
            tox -r -e newsfragment
      - run:
          name: Check manifest-checker.
          command: |
            tox -r -e manifest-checker
      - run:
          name: Check pyflakes.
          command: |
            tox -r -e pyflakes
      - run:
          name: Check the narrative documentation.
          command: |
            tox -r -e narrativedocs
      - run:
          name: Check the API documentation.
          command: |
            tox -r -e apidocs

  build_macos_py27:
    macos:
      # We don't use the xcode, but we need to put something here.
      xcode: "9.0"

    working_directory: ~/repo

    steps:
      # Get the source.
      - checkout

      - run:
          name: Prepare the macOS environment.
          command: |
            export PATH=/usr/local/bin:$PATH:/Users/distiller/Library/Python/2.7/bin
            python --version
            pip install -q --user --ignore-installed --upgrade virtualenv
            pip install -q tox --user

      # Run tests with tox without any cached dependencies.
      - run:
          name: Test with the default reactor.
          command: |
            export PATH=/usr/local/bin:$PATH:/Users/distiller/Library/Python/2.7/bin
            tox -r -e py27-alldeps-withcov-posix twisted


# First we run the static checkers, and only if they pass we spin the macOS.
# in this way we should save some macOS minutes.
workflows:
  version: 2
  all_tests:
    jobs:
      - build_static_checkers
      - build_macos_py27
          requires:
            - build_static_checkers
